<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NLI ‚Äî Dashboard Contabilit√†</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0c0f14;
    --surface: #151921;
    --surface-2: #1c2230;
    --border: #2a3040;
    --text: #e4e8f0;
    --text-dim: #8891a4;
    --accent: #4f8cff;
    --accent-glow: rgba(79,140,255,0.15);
    --green: #34d399;
    --green-glow: rgba(52,211,153,0.12);
    --amber: #fbbf24;
    --amber-glow: rgba(251,191,36,0.12);
    --red: #f87171;
    --red-glow: rgba(248,113,113,0.12);
    --purple: #a78bfa;
    --radius: 12px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); line-height: 1.7; }
  #login-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease, visibility 0.5s ease; }
  #login-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
  .login-box { width: 100%; max-width: 400px; padding: 48px 40px; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; text-align: center; position: relative; box-shadow: 0 0 80px rgba(79,140,255,0.06); }
  .login-box::before { content: ''; position: absolute; top: -1px; left: -1px; right: -1px; bottom: -1px; border-radius: 17px; background: linear-gradient(135deg, rgba(79,140,255,0.15), transparent 50%, rgba(167,139,250,0.1)); z-index: -1; }
  .login-logo { font-size: 32px; font-weight: 700; margin-bottom: 4px; letter-spacing: -1px; }
  .login-logo span { color: var(--accent); }
  .login-sub { font-size: 13px; color: var(--text-dim); margin-bottom: 36px; }
  .login-field { position: relative; margin-bottom: 16px; }
  .login-field input { width: 100%; padding: 14px 18px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 15px; outline: none; transition: border-color 0.2s; }
  .login-field input:focus { border-color: var(--accent); }
  .login-field input::placeholder { color: var(--text-dim); }
  .login-btn { width: 100%; padding: 14px; background: var(--accent); color: #fff; border: none; border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 8px; transition: background 0.2s, transform 0.1s; }
  .login-btn:hover { background: #3d7ae8; }
  .login-btn:active { transform: scale(0.98); }
  .login-error { color: var(--red); font-size: 13px; margin-top: 14px; min-height: 20px; }
  .login-hint { font-size: 11px; color: var(--text-dim); margin-top: 24px; opacity: 0.6; }
  #dashboard { display: none; }
  #dashboard.visible { display: block; }
  .topbar { display: flex; align-items: center; justify-content: space-between; padding: 16px 40px; border-bottom: 1px solid var(--border); background: var(--surface); position: sticky; top: 0; z-index: 100; }
  .topbar-brand { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
  .topbar-brand span { color: var(--accent); }
  .topbar-right { display: flex; align-items: center; gap: 20px; }
  .topbar-status { font-size: 12px; color: var(--text-dim); }
  .topbar-status .dot { display: inline-block; width: 7px; height: 7px; border-radius: 50%; background: var(--green); margin-right: 6px; animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  .logout-btn { background: var(--surface-2); border: 1px solid var(--border); color: var(--text-dim); padding: 6px 16px; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 12px; cursor: pointer; transition: all 0.2s; }
  .logout-btn:hover { color: var(--text); border-color: var(--text-dim); }
  .nav-tabs { display: flex; gap: 0; padding: 0 40px; background: var(--surface); border-bottom: 1px solid var(--border); overflow-x: auto; }
  .nav-tab { padding: 14px 24px; font-size: 13px; font-weight: 500; color: var(--text-dim); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
  .nav-tab:hover { color: var(--text); }
  .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .content { max-width: 1200px; margin: 0 auto; padding: 40px; }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }
  .page-header { margin-bottom: 32px; }
  .page-header h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
  .page-header p { color: var(--text-dim); font-size: 14px; margin-top: 4px; }
  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 40px; }
  .kpi-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; }
  .kpi-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 8px; }
  .kpi-value { font-size: 30px; font-weight: 700; letter-spacing: -1px; }
  .kpi-sub { font-size: 12px; color: var(--text-dim); margin-top: 6px; }
  .kpi-value.positive { color: var(--green); }
  .kpi-value.negative { color: var(--red); }
  .kpi-value.neutral { color: var(--text); }
  .kpi-value.waiting { color: var(--text-dim); }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 28px 32px; margin-bottom: 16px; }
  .card h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
  .card p { font-size: 14px; color: var(--text-dim); line-height: 1.75; }
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13.5px; }
  th { text-align: left; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); padding: 12px 16px; border-bottom: 2px solid var(--border); white-space: nowrap; }
  td { padding: 14px 16px; border-bottom: 1px solid var(--border); color: var(--text-dim); }
  tr:last-child td { border-bottom: none; }
  td strong { color: var(--text); font-weight: 500; }
  .badge { display: inline-flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; padding: 4px 10px; border-radius: 100px; }
  .badge.upcoming { background: var(--amber-glow); color: var(--amber); }
  .badge.ok { background: var(--green-glow); color: var(--green); }
  .badge.overdue { background: var(--red-glow); color: var(--red); }
  .badge.info { background: var(--accent-glow); color: var(--accent); }
  .alert-box { padding: 20px 24px; border-radius: var(--radius); margin-bottom: 16px; font-size: 14px; }
  .alert-box.warning { background: var(--amber-glow); border: 1px solid rgba(251,191,36,0.2); color: var(--amber); }
  .alert-box.info { background: var(--accent-glow); border: 1px solid rgba(79,140,255,0.2); color: var(--accent); }
  .alert-box.success { background: var(--green-glow); border: 1px solid rgba(52,211,153,0.2); color: var(--green); }
  .alert-box.danger { background: var(--red-glow); border: 1px solid rgba(248,113,113,0.3); color: var(--red); font-weight: 600; }
  .badge-certezza { display: inline-block; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; padding: 3px 10px; border-radius: 100px; }
  .badge-certezza.certo { background: var(--green-glow); color: var(--green); }
  .badge-certezza.stimato { background: var(--amber-glow); color: var(--amber); }
  .badge-certezza.atteso { background: rgba(255,255,255,0.06); color: var(--text-dim); }
  .month-card { margin-bottom: 24px; }
  .month-card .month-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .month-card .month-header h3 { font-size: 16px; font-weight: 600; }
  .month-card .month-saldo { font-size: 14px; font-weight: 600; }
  .section-label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin: 16px 0 8px; }
  .totals-row { display: flex; gap: 24px; padding: 14px 16px; font-size: 13px; font-weight: 600; border-top: 2px solid var(--border); margin-top: 4px; }
  .totals-row span { color: var(--text-dim); }
  .totals-row .val { color: var(--text); }
  td.importo { font-family: 'JetBrains Mono', monospace; font-size: 13px; white-space: nowrap; }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
  .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.4; }
  .empty-state h3 { font-size: 18px; color: var(--text); margin-bottom: 8px; }
  .empty-state p { font-size: 14px; max-width: 400px; margin: 0 auto; }
  .checklist { list-style: none; padding: 0; }
  .checklist li { padding: 14px 0; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; gap: 14px; font-size: 14px; }
  .checklist li:last-child { border-bottom: none; }
  .check-box { width: 22px; height: 22px; border-radius: 6px; flex-shrink: 0; margin-top: 1px; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; }
  .check-box.pending { border: 2px solid var(--amber); color: var(--amber); }
  .check-box.done { border: 2px solid var(--green); background: var(--green-glow); color: var(--green); }
  .last-update { text-align: center; padding: 40px 20px 20px; font-size: 12px; color: var(--text-dim); opacity: 0.5; }
  .section-header { margin: 32px 0 16px 0; }
  .section-header:first-of-type { margin-top: 0; }
  .section-header h3 { font-size: 15px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.2px; padding-bottom: 10px; border-bottom: 2px solid var(--border); }
  .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 40px; }
  .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; }
  .chart-card h4 { font-size: 13px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 16px; }
  .chart-card canvas { width: 100% !important; max-height: 260px; }
  .badge-competenza { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; padding: 2px 8px; border-radius: 100px; margin-left: 8px; vertical-align: middle; }
  .badge-competenza.comp-2025 { background: var(--amber-glow); color: var(--amber); }
  .badge-competenza.comp-verify { background: var(--amber-glow); color: var(--amber); border: 1px dashed var(--amber); }
  .badge-competenza.comp-2026 { background: var(--green-glow); color: var(--green); }
  tr.row-comp-2025 td { opacity: 0.55; }
  tr.row-comp-2025 td .badge-competenza { opacity: 1; }
  tr.row-comp-verify td { opacity: 0.75; }
  tr.row-comp-verify td .badge-competenza { opacity: 1; }
  .totals-breakdown { padding: 10px 16px; font-size: 13px; color: var(--text-dim); border-top: 1px solid var(--border); display: flex; gap: 24px; flex-wrap: wrap; }
  .totals-breakdown .val-green { color: var(--green); font-weight: 600; }
  .totals-breakdown .val-amber { color: var(--amber); font-weight: 600; }
  .totals-breakdown .val-dim { color: var(--text-dim); font-weight: 600; }
  @media (max-width: 768px) { .topbar { padding: 14px 16px; } .nav-tabs { padding: 0 16px; } .content { padding: 24px 16px; } .page-header h1 { font-size: 22px; } .kpi-grid { grid-template-columns: 1fr 1fr; } .charts-grid { grid-template-columns: 1fr; } .login-box { margin: 20px; padding: 36px 28px; } }
</style>
</head>
<body>
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">NLI <span>Dashboard</span></div>
    <div class="login-sub">Next Level Italia SAS ‚Äî Area Riservata</div>
    <div class="login-field">
      <input type="password" id="pwd-input" placeholder="Password di accesso" autocomplete="off" autofocus>
    </div>
    <button class="login-btn" id="login-btn" onclick="tryLogin()">Accedi</button>
    <div class="login-error" id="login-error"></div>
    <div class="login-hint">Accesso riservato ai soci</div>
  </div>
</div>
<div id="dashboard">
  <div class="topbar">
    <div class="topbar-brand">NLI <span>Dashboard</span></div>
    <div class="topbar-right">
      <div class="topbar-status"><span class="dot"></span>Ultimo aggiornamento: <span id="last-update-date">‚Äî</span></div>
      <button class="logout-btn" onclick="doLogout()">Esci</button>
    </div>
  </div>
  <div class="nav-tabs">
    <div class="nav-tab active" onclick="switchTab('overview')">Panoramica</div>
    <div class="nav-tab" onclick="switchTab('entrate')">Entrate</div>
    <div class="nav-tab" onclick="switchTab('uscite')">Uscite</div>
    <div class="nav-tab" onclick="switchTab('banca')">Banca</div>
    <div class="nav-tab" onclick="switchTab('previsionale')">Previsionale</div>
    <div class="nav-tab" onclick="switchTab('scadenzario')">Scadenzario</div>
    <div class="nav-tab" onclick="switchTab('alert')">Alert</div>
    <div class="nav-tab" onclick="switchTab('setup')">Setup Iniziale</div>
  </div>
  <div class="content">
    <!-- Panoramica -->
    <div class="tab-panel active" id="tab-overview">
      <div class="page-header"><h1>Panoramica</h1><p>KPI e stato generale di Next Level Italia SAS</p></div>
      <div id="overview-status" class="alert-box info" style="margin-bottom:28px;"></div>
      <div class="kpi-grid" id="kpi-grid"></div>
      <div class="section-header"><h3 style="color:var(--green);">Entrate</h3></div>
      <div class="charts-grid">
        <div class="chart-card"><h4>Entrate Mensili</h4><canvas id="chart-entrate"></canvas></div>
        <div class="chart-card"><h4>Composizione Entrate</h4><canvas id="chart-composizione-entrate"></canvas></div>
      </div>
      <div class="section-header"><h3 style="color:var(--red);">Uscite</h3></div>
      <div class="charts-grid">
        <div class="chart-card"><h4>Uscite Mensili</h4><canvas id="chart-uscite"></canvas></div>
        <div class="chart-card"><h4>Composizione Costi</h4><canvas id="chart-composizione-costi"></canvas></div>
      </div>
      <div class="section-header"><h3>Performance</h3></div>
      <div class="charts-grid">
        <div class="chart-card"><h4>EBITDA Cumulativo vs Target ‚Ç¨100k</h4><canvas id="chart-ebitda-target"></canvas></div>
        <div class="chart-card"><h4>EBITDA e Utile Netto</h4><canvas id="chart-ebitda-utile"></canvas></div>
      </div>
      <div class="card"><h3>Stato lavori</h3><p id="stato-lavori"></p></div>
    </div>
    <!-- Scadenzario -->
    <div class="tab-panel" id="tab-scadenzario">
      <div class="page-header"><h1>Scadenzario</h1><p>Scadenze fiscali, contributive e amministrative</p></div>
      <div id="scadenzario-alert" class="alert-box info" style="margin-bottom:24px;">Regime semplificato ‚Äî IVA trimestrale. Tutti gli adempimenti sono gestiti dal commercialista.</div>
      <div class="card"><div class="table-wrap"><table><thead><tr><th>Scadenza</th><th>Adempimento</th><th>Frequenza</th><th>Chi</th><th>Stato</th></tr></thead><tbody id="scadenze-body"></tbody></table></div></div>
    </div>
    <!-- Entrate -->
    <div class="tab-panel" id="tab-entrate">
      <div class="page-header"><h1>Entrate</h1><p>Fatture emesse e incassi mensili</p></div>
      <div id="entrate-content"></div>
    </div>
    <!-- Uscite -->
    <div class="tab-panel" id="tab-uscite">
      <div class="page-header"><h1>Uscite</h1><p>Fatture ricevute e pagamenti mensili</p></div>
      <div id="uscite-content"></div>
    </div>
    <!-- Banca -->
    <div class="tab-panel" id="tab-banca">
      <div class="page-header"><h1>Banca</h1><p>Movimenti conto corrente Intesa Sanpaolo</p></div>
      <div id="banca-content"></div>
    </div>
    <!-- Previsionale -->
    <div class="tab-panel" id="tab-previsionale">
      <div class="page-header"><h1>Previsionale</h1><p>Cash flow forecast ‚Äî costi certi, stimati ed entrate attese</p></div>
      <div id="previsionale-content"></div>
    </div>
    <!-- Alert -->
    <div class="tab-panel" id="tab-alert">
      <div class="page-header"><h1>Alert e Suggerimenti</h1><p>Segnalazioni, anomalie e consigli proattivi</p></div>
      <div id="alert-list"></div>
      <div class="card" style="margin-top:16px;"><h3>Suggerimenti</h3><p id="suggerimenti-text"></p></div>
    </div>
    <!-- Setup -->
    <div class="tab-panel" id="tab-setup">
      <div class="page-header"><h1>Setup Iniziale</h1><p>Checklist per avviare la contabilit√† completa</p></div>
      <div class="card"><h3>Informazioni necessarie</h3>
        <ul class="checklist" id="setup-checklist"></ul>
      </div>
    </div>
  </div>
  <div class="last-update" id="footer-update"></div>
</div>
<script>
  const HASH = 'ed9ec9d0b70b2b77ff7dbc74cddd4673fbcc4020fe75483d9d071830830e3aef';
  const SESSION_KEY = 'nli_dash_auth';

  if (sessionStorage.getItem(SESSION_KEY) === 'true') { showDashboard(); }
  document.getElementById('pwd-input').addEventListener('keydown', function(e) { if (e.key === 'Enter') tryLogin(); });

  async function hashPassword(pwd) {
    const data = new TextEncoder().encode(pwd);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
  }

  async function tryLogin() {
    const pwd = document.getElementById('pwd-input').value;
    if (!pwd) { document.getElementById('login-error').textContent = 'Inserisci la password'; return; }
    const hash = await hashPassword(pwd);
    if (hash === HASH) {
      sessionStorage.setItem(SESSION_KEY, 'true');
      showDashboard();
    } else {
      document.getElementById('login-error').textContent = 'Password errata';
      document.getElementById('pwd-input').value = '';
      document.getElementById('pwd-input').focus();
    }
  }

  function showDashboard() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('dashboard').classList.add('visible');
    loadData();
  }

  function doLogout() {
    sessionStorage.removeItem(SESSION_KEY);
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('dashboard').classList.remove('visible');
    document.getElementById('pwd-input').value = '';
    document.getElementById('pwd-input').focus();
  }

  function switchTab(tabName) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
  }

  async function loadData() {
    try {
      const resp = await fetch('data.json?' + Date.now());
      const d = await resp.json();

      // Last update
      document.getElementById('last-update-date').textContent = d.lastUpdate;
      document.getElementById('footer-update').textContent = 'Next Level Italia SAS ‚Äî Dashboard Contabilit√† ‚Äî Ultimo aggiornamento: ' + d.lastUpdate;

      // Overview status
      document.getElementById('overview-status').textContent = d.statusMessage;
      document.getElementById('stato-lavori').textContent = d.statoLavori;

      // KPI
      const kpiGrid = document.getElementById('kpi-grid');
      kpiGrid.innerHTML = d.kpi.map(k =>
        '<div class="kpi-card"><div class="kpi-label">' + esc(k.label) + '</div><div class="kpi-value ' + esc(k.class) + '">' + esc(k.value) + '</div><div class="kpi-sub">' + esc(k.sub) + '</div></div>'
      ).join('');

      // Scadenzario ‚Äî calcolo dinamico giorni rimanenti
      const scBody = document.getElementById('scadenze-body');
      const mesiIt = { 'gen': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'mag': 4, 'giu': 5, 'lug': 6, 'ago': 7, 'set': 8, 'ott': 9, 'nov': 10, 'dic': 11 };
      const oggi = new Date(); oggi.setHours(0,0,0,0);
      function parseScadData(str) {
        // Formato: "16 Feb 2026", "30 Apr 2026", "Fine Feb 2026" ecc.
        const m = str.match(/(\d{1,2})\s+(\w{3})\w*\s+(\d{4})/i);
        if (!m) return null;
        const giorno = parseInt(m[1]);
        const meseStr = m[2].toLowerCase().substring(0, 3);
        const anno = parseInt(m[3]);
        if (mesiIt[meseStr] === undefined) return null;
        return new Date(anno, mesiIt[meseStr], giorno);
      }
      function badgeScadenza(s) {
        const dataScad = parseScadData(s.data);
        if (!dataScad) return '<span class="badge ' + esc(s.stato) + '">' + esc(s.statoLabel) + '</span>';
        const diffMs = dataScad - oggi;
        const diffGg = Math.ceil(diffMs / 86400000);
        if (diffGg < 0) return '<span class="badge overdue">SCADUTO ' + Math.abs(diffGg) + ' gg fa</span>';
        if (diffGg === 0) return '<span class="badge overdue">OGGI!</span>';
        if (diffGg <= 7) return '<span class="badge upcoming">URGENTE ‚Äî ' + diffGg + ' gg</span>';
        if (diffGg <= 30) return '<span class="badge upcoming">' + diffGg + ' giorni</span>';
        return '<span class="badge info">' + diffGg + ' giorni</span>';
      }
      scBody.innerHTML = d.scadenze.map(s =>
        '<tr><td><strong>' + esc(s.data) + '</strong></td><td>' + esc(s.adempimento) + '</td><td>' + esc(s.frequenza) + '</td><td>' + esc(s.chi || '') + '</td><td>' + badgeScadenza(s) + '</td></tr>'
      ).join('');

      // Entrate
      const entrateEl = document.getElementById('entrate-content');
      if (d.movimentiMensili && d.movimentiMensili.length) {
        entrateEl.innerHTML = d.movimentiMensili.map(m => {
          if (m.entrate.length === 0) return '';
          // Calcola totali per competenza
          let tot2026 = 0, tot2025 = 0, totVerify = 0;
          m.entrate.forEach(e => {
            const imp = parseEuro(e.importo);
            const comp = e.competenza || '2026';
            if (comp === '2025') tot2025 += imp;
            else if (comp === 'da verificare') totVerify += imp;
            else tot2026 += imp;
          });
          let html = '<div class="card month-card"><div class="month-header"><h3>' + esc(m.mese) + '</h3><div class="month-saldo" style="color:var(--green);">Incassi: ' + esc(m.totaleEntrate) + '</div></div>';
          html += '<div class="table-wrap"><table><thead><tr><th>Data</th><th>Voce</th><th>Voce Bilancio</th><th>Importo</th><th>Note</th></tr></thead><tbody>';
          html += m.entrate.map(e => {
            const comp = e.competenza || '2026';
            let rowClass = '';
            let badgeHtml = '';
            if (comp === '2025') {
              rowClass = ' class="row-comp-2025"';
              badgeHtml = ' <span class="badge-competenza comp-2025">2025</span>';
            } else if (comp === 'da verificare') {
              rowClass = ' class="row-comp-verify"';
              badgeHtml = ' <span class="badge-competenza comp-verify">da verificare</span>';
            } else if (comp === '2026') {
              badgeHtml = ' <span class="badge-competenza comp-2026">2026</span>';
            }
            return '<tr' + rowClass + '><td><strong>' + esc(e.data) + '</strong></td><td>' + esc(e.voce) + '</td><td>' + esc(e.voceBilancio) + '</td><td class="importo">' + esc(e.importo) + badgeHtml + '</td><td>' + esc(e.note) + '</td></tr>';
          }).join('');
          html += '</tbody></table></div>';
          html += '<div class="totals-row"><span>Totale incassi: <span class="val" style="color:var(--green);">' + esc(m.totaleEntrate) + '</span></span></div>';
          // Breakdown competenza
          if (tot2025 > 0 || totVerify > 0) {
            html += '<div class="totals-breakdown">';
            html += '<span>Competenza 2026: <span class="val-green">\u20AC' + tot2026.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</span></span>';
            if (tot2025 > 0) html += '<span>Incassi fatt. 2025: <span class="val-dim">\u20AC' + tot2025.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</span></span>';
            if (totVerify > 0) html += '<span>Da verificare: <span class="val-amber">\u20AC' + totVerify.toLocaleString('it-IT', {minimumFractionDigits: 2}) + '</span></span>';
            html += '</div>';
          }
          html += '</div>';
          return html;
        }).join('');
        if (!entrateEl.innerHTML.trim()) entrateEl.innerHTML = '<div class="empty-state"><div class="icon">üì•</div><h3>Nessuna entrata</h3><p>Le entrate compariranno con le prime fatture emesse e incassi registrati.</p></div>';
      } else {
        entrateEl.innerHTML = '<div class="empty-state"><div class="icon">üì•</div><h3>Nessuna entrata</h3><p>Le entrate compariranno con le prime fatture emesse e incassi registrati.</p></div>';
      }

      // Uscite
      const usciteEl = document.getElementById('uscite-content');
      if (d.movimentiMensili && d.movimentiMensili.length) {
        usciteEl.innerHTML = d.movimentiMensili.map(m => {
          if (m.uscite.length === 0) return '';
          const ebitdaVal = m.ebitda || '‚Äî';
          const ebitdaColor = ebitdaVal.includes('‚àí') ? 'var(--red)' : (ebitdaVal === '‚Äî' ? 'var(--text-dim)' : 'var(--green)');
          let html = '<div class="card month-card"><div class="month-header"><h3>' + esc(m.mese) + '</h3><div class="month-saldo" style="color:var(--red);">Totale: ' + esc(m.totaleUscite) + ' <span style="margin-left:12px;color:' + ebitdaColor + '">EBITDA: ' + esc(ebitdaVal) + '</span></div></div>';
          html += '<div class="table-wrap"><table><thead><tr><th>Data</th><th>Voce</th><th>Voce Bilancio</th><th>Importo</th><th>Note</th></tr></thead><tbody>';
          html += m.uscite.map(e => '<tr><td><strong>' + esc(e.data) + '</strong></td><td>' + esc(e.voce) + '</td><td>' + esc(e.voceBilancio) + '</td><td class="importo">' + esc(e.importo) + '</td><td>' + esc(e.note) + '</td></tr>').join('');
          html += '</tbody></table></div>';
          html += '<div class="totals-row"><span>Totale uscite: <span class="val" style="color:var(--red);">' + esc(m.totaleUscite) + '</span></span></div>';
          html += '</div>';
          return html;
        }).join('');
        if (!usciteEl.innerHTML.trim()) usciteEl.innerHTML = '<div class="empty-state"><div class="icon">üì§</div><h3>Nessuna uscita</h3><p>Le uscite compariranno con le prime fatture ricevute e pagamenti registrati.</p></div>';
      } else {
        usciteEl.innerHTML = '<div class="empty-state"><div class="icon">üì§</div><h3>Nessuna uscita</h3><p>Le uscite compariranno con le prime fatture ricevute e pagamenti registrati.</p></div>';
      }

      // Banca
      const bancaEl = document.getElementById('banca-content');
      if (d.banca) {
        let bhtml = '<div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;"><h3>' + esc(d.banca.conto) + '</h3><div style="font-size:13px;color:var(--text-dim);">' + esc(d.banca.ultimoAggiornamento) + '</div></div>';
        if (d.banca.saldoAttuale !== '‚Äî') {
          bhtml += '<div style="font-size:28px;font-weight:700;margin-bottom:20px;">' + esc(d.banca.saldoAttuale) + '</div>';
        }
        if (!d.banca.movimenti || d.banca.movimenti.length === 0) {
          // Mostra riepilogo se ci sono dati di sintesi
          if (d.banca.saldoInizioMese && d.banca.saldoInizioMese !== '‚Äî') {
            bhtml += '<div class="kpi-grid" style="margin-bottom:20px;">';
            bhtml += '<div class="kpi-card"><div class="kpi-label">Saldo Iniziale</div><div class="kpi-value neutral">' + esc(d.banca.saldoInizioMese) + '</div></div>';
            bhtml += '<div class="kpi-card"><div class="kpi-label">Saldo Finale</div><div class="kpi-value positive">' + esc(d.banca.saldoAttuale) + '</div></div>';
            bhtml += '<div class="kpi-card"><div class="kpi-label">Entrate Totali</div><div class="kpi-value positive">' + esc(d.banca.entrateGennaio || '‚Äî') + '</div></div>';
            bhtml += '<div class="kpi-card"><div class="kpi-label">Uscite Totali</div><div class="kpi-value negative">' + esc(d.banca.usciteGennaio || '‚Äî') + '</div></div>';
            bhtml += '<div class="kpi-card"><div class="kpi-label">Flusso Netto</div><div class="kpi-value positive">' + esc(d.banca.flussoNetto || '‚Äî') + '</div></div>';
            bhtml += '<div class="kpi-card"><div class="kpi-label">Movimenti Totali</div><div class="kpi-value neutral">' + (d.banca.movimentiTotali || '‚Äî') + '</div></div>';
            bhtml += '</div>';
            bhtml += '<div class="alert-box info">Dettaglio movimenti disponibile nelle sezioni Entrate e Uscite. Per il dettaglio completo per riga bancaria, caricare il file estratto conto.</div>';
          } else {
            bhtml += '<div class="empty-state" style="padding:40px 20px;"><div class="icon">üè¶</div><h3>In attesa del primo estratto conto</h3><p>I movimenti bancari Intesa Sanpaolo compariranno qui non appena acquisito il primo estratto conto.</p></div>';
          }
        } else {
          const alias = d.bancaAliasDescrizioni || {};
          const hasAlias = Object.keys(alias).length > 0;
          let unmatchedCount = 0;
          bhtml += '<div class="table-wrap"><table><thead><tr><th>Data</th><th>Descrizione</th><th>Dare</th><th>Avere</th><th>Saldo</th></tr></thead><tbody>';
          bhtml += d.banca.movimenti.map(mv => {
            const orig = mv.descrizione;
            const matchKey = Object.keys(alias).find(k => orig.includes(k));
            let descHtml;
            if (matchKey) {
              descHtml = '<span title="' + esc(orig) + '" style="border-bottom:1px dotted var(--text-dim);cursor:help;">' + esc(alias[matchKey]) + '</span>';
            } else if (hasAlias) {
              unmatchedCount++;
              descHtml = '<span style="color:var(--amber);">' + esc(orig) + '</span> <span class="badge upcoming" style="font-size:9px;padding:2px 6px;">da verificare</span>';
            } else {
              descHtml = esc(orig);
            }
            return '<tr><td><strong>' + esc(mv.data) + '</strong></td><td>' + descHtml + '</td><td class="importo">' + esc(mv.dare) + '</td><td class="importo">' + esc(mv.avere) + '</td><td class="importo">' + esc(mv.saldo) + '</td></tr>';
          }).join('');
          bhtml += '</tbody></table></div>';
          if (unmatchedCount > 0) {
            bhtml += '<div class="alert-box warning" style="margin-top:12px;">' + unmatchedCount + ' moviment' + (unmatchedCount === 1 ? 'o non ha' : 'i non hanno') + ' una descrizione mappata ‚Äî da verificare in bancaAliasDescrizioni.</div>';
          }
        }
        bhtml += '</div>';
        bancaEl.innerHTML = bhtml;
      }

      // Previsionale
      const prevEl = document.getElementById('previsionale-content');
      if (d.previsionale && d.previsionale.length) {
        prevEl.innerHTML = d.previsionale.map(m => {
          let html = '<div class="card month-card"><div class="month-header"><h3>' + esc(m.mese) + '</h3><div class="month-saldo">Saldo stimato: ' + esc(m.saldoStimato) + '</div></div>';
          html += '<div class="table-wrap"><table><thead><tr><th>Voce</th><th>Tipo</th><th>Importo</th><th>Certezza</th></tr></thead><tbody>';
          html += m.voci.map(v => '<tr><td><strong>' + esc(v.voce) + '</strong></td><td>' + esc(v.tipo) + '</td><td class="importo">' + esc(v.importo) + '</td><td><span class="badge-certezza ' + esc(v.certezza) + '">' + esc(v.certezza) + '</span></td></tr>').join('');
          html += '</tbody></table></div>';
          html += '<div class="totals-row"><span>Uscite stimate: <span class="val">' + esc(m.totaleUsciteStimate) + '</span></span><span>Entrate stimate: <span class="val">' + esc(m.totaleEntrateStimate) + '</span></span></div>';
          html += '</div>';
          return html;
        }).join('');
      } else {
        prevEl.innerHTML = '<div class="empty-state"><div class="icon">üîÆ</div><h3>Previsionale vuoto</h3><p>Le previsioni di cassa compariranno qui con i primi dati ricorrenti.</p></div>';
      }

      // Alert
      const alertList = document.getElementById('alert-list');
      alertList.innerHTML = d.alert.map(a =>
        '<div class="alert-box ' + esc(a.tipo) + '">' + esc(a.testo) + '</div>'
      ).join('');
      document.getElementById('suggerimenti-text').textContent = d.suggerimenti;

      // Setup checklist
      const cl = document.getElementById('setup-checklist');
      cl.innerHTML = d.setupChecklist.map(item => {
        const cls = item.done ? 'done' : 'pending';
        const icon = item.done ? '‚úì' : '?';
        return '<li><div class="check-box ' + cls + '">' + icon + '</div><div><strong>' + esc(item.label) + '</strong> ‚Äî ' + esc(item.desc) + '</div></li>';
      }).join('');

      // Charts
      renderCharts(d);

    } catch (err) {
      console.error('Errore caricamento data.json:', err);
    }
  }

  function esc(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function parseEuro(s) {
    if (!s || s === '‚Äî') return 0;
    return parseFloat(s.replace('‚Ç¨', '').replace(/\./g, '').replace(',', '.').replace('‚àí', '-').replace('‚Äì', '-').trim()) || 0;
  }

  let chartInstances = [];
  function renderCharts(d) {
    chartInstances.forEach(c => c.destroy());
    chartInstances = [];
    const mesi = d.movimentiMensili || [];
    const labels = mesi.map(m => m.mese.replace(' 2026', '').substring(0, 3));
    const entrateData = mesi.map(m => parseEuro(m.totaleEntrate));
    const usciteData = mesi.map(m => parseEuro(m.totaleUscite));
    const utileNettoData = mesi.map(m => parseEuro(m.utileNetto || m.saldo));
    const ebitdaMensile = mesi.map(m => parseEuro(m.ebitda));
    const target = d.ebitdaTargetAnnuo || 100000;
    const targetMensile = target / 12;

    const baseOpts = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#8891a4', font: { family: 'DM Sans', size: 11 } } } },
      scales: {
        x: { ticks: { color: '#8891a4', font: { family: 'DM Sans', size: 11 } }, grid: { color: 'rgba(42,48,64,0.5)' } },
        y: { ticks: { color: '#8891a4', font: { family: 'DM Sans', size: 11 }, callback: function(v) { return '‚Ç¨' + v.toLocaleString('it-IT'); } }, grid: { color: 'rgba(42,48,64,0.5)' } }
      }
    };
    const doughnutColors = ['#4f8cff', '#34d399', '#a78bfa', '#fbbf24', '#f472b6', '#38bdf8', '#fb923c', '#f87171', '#6ee7b7', '#c084fc', '#facc15', '#818cf8'];

    // === ENTRATE ===

    // 1. Entrate Mensili (bar verde)
    chartInstances.push(new Chart(document.getElementById('chart-entrate'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{ label: 'Entrate', data: entrateData, backgroundColor: '#34d399', borderRadius: 4 }]
      },
      options: { ...baseOpts, plugins: { ...baseOpts.plugins, legend: { display: false } } }
    }));

    // 2. Composizione Entrate (doughnut per cliente)
    const entrateMap = {};
    mesi.forEach(m => {
      (m.entrate || []).forEach(e => {
        const voce = e.voce || 'Altro';
        entrateMap[voce] = (entrateMap[voce] || 0) + parseEuro(e.importo);
      });
    });
    const entrateLabels = Object.keys(entrateMap);
    const entrateValues = Object.values(entrateMap);
    chartInstances.push(new Chart(document.getElementById('chart-composizione-entrate'), {
      type: 'doughnut',
      data: {
        labels: entrateLabels.map(l => l.length > 25 ? l.substring(0, 25) + '‚Ä¶' : l),
        datasets: [{ data: entrateValues, backgroundColor: doughnutColors.slice(0, entrateLabels.length), borderWidth: 0 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#8891a4', font: { family: 'DM Sans', size: 11 }, padding: 12, usePointStyle: true, pointStyle: 'circle' } },
          tooltip: { callbacks: { label: function(ctx) { return ctx.label + ': ‚Ç¨' + ctx.parsed.toLocaleString('it-IT'); } } }
        }
      }
    }));

    // === USCITE ===

    // 3. Uscite Mensili + Media (bar rosso + linea media)
    const avgUscite = usciteData.length ? usciteData.reduce((a, b) => a + b, 0) / usciteData.length : 0;
    chartInstances.push(new Chart(document.getElementById('chart-uscite'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label: 'Uscite', data: usciteData, backgroundColor: '#f87171', borderRadius: 4, order: 2 },
          { label: 'Media', data: usciteData.map(() => avgUscite), type: 'line', borderColor: '#fbbf24', borderDash: [6, 4], pointRadius: 0, fill: false, order: 1 }
        ]
      },
      options: baseOpts
    }));

    // 4. Composizione Costi (doughnut per voceBilancio)
    const costiMap = {};
    mesi.forEach(m => {
      (m.uscite || []).forEach(u => {
        const voce = u.voceBilancio || 'Altro';
        costiMap[voce] = (costiMap[voce] || 0) + parseEuro(u.importo);
      });
    });
    const costiLabels = Object.keys(costiMap);
    const costiValues = Object.values(costiMap);
    chartInstances.push(new Chart(document.getElementById('chart-composizione-costi'), {
      type: 'doughnut',
      data: {
        labels: costiLabels.map(l => l.length > 25 ? l.substring(0, 25) + '‚Ä¶' : l),
        datasets: [{ data: costiValues, backgroundColor: doughnutColors.slice(0, costiLabels.length), borderWidth: 0 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#8891a4', font: { family: 'DM Sans', size: 11 }, padding: 12, usePointStyle: true, pointStyle: 'circle' } },
          tooltip: { callbacks: { label: function(ctx) { return ctx.label + ': ‚Ç¨' + ctx.parsed.toLocaleString('it-IT'); } } }
        }
      }
    }));

    // === PERFORMANCE ===

    // 5. EBITDA Cumulativo vs Target
    let cumEbitda = [];
    ebitdaMensile.forEach((v, i) => { cumEbitda.push((cumEbitda[i - 1] || 0) + v); });
    const allMonthLabels = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
    const targetLine = allMonthLabels.map((_, i) => targetMensile * (i + 1));
    const cumEbitdaFull = allMonthLabels.map((_, i) => i < cumEbitda.length ? cumEbitda[i] : null);
    chartInstances.push(new Chart(document.getElementById('chart-ebitda-target'), {
      type: 'line',
      data: {
        labels: allMonthLabels,
        datasets: [
          { label: 'EBITDA Cumulativo', data: cumEbitdaFull, borderColor: '#4f8cff', backgroundColor: 'rgba(79,140,255,0.1)', fill: true, tension: 0.3, pointRadius: 4, pointBackgroundColor: '#4f8cff', spanGaps: false },
          { label: 'Target ‚Ç¨100k', data: targetLine, borderColor: '#fbbf24', borderDash: [6, 4], pointRadius: 0, fill: false }
        ]
      },
      options: { ...baseOpts, scales: { ...baseOpts.scales, y: { ...baseOpts.scales.y, ticks: { ...baseOpts.scales.y.ticks, callback: function(v) { return '‚Ç¨' + (v / 1000).toFixed(0) + 'k'; } } } } }
    }));

    // 6. EBITDA e Utile Netto (bar affiancati)
    chartInstances.push(new Chart(document.getElementById('chart-ebitda-utile'), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          { label: 'EBITDA', data: ebitdaMensile, backgroundColor: '#4f8cff', borderRadius: 4 },
          { label: 'Utile Netto', data: utileNettoData, backgroundColor: '#34d399', borderRadius: 4 }
        ]
      },
      options: baseOpts
    }));
  }
</script>
</body>
</html>
